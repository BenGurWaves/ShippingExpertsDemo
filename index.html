<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shipping Experts — Final Fix</title>
<style>
  :root{--accent:#FF6700}
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f6f7f8;color:#111}
  header{background:var(--accent);color:#fff;padding:10px 16px;display:flex;justify-content:space-between;align-items:center;position:relative;z-index:10}
  h1{margin:0;font-size:18px}
  #header-actions{display:flex;gap:12px;align-items:center}
  button{background:#fff;border:0;padding:8px 10px;border-radius:6px;cursor:pointer}
  .ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.25)}
  .profile-circle{width:40px;height:40px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#000;cursor:pointer}
  .profile-circle img{width:100%;height:100%;object-fit:cover;display:block}
  .hidden{display:none !important}

  /* overlay modals: use display controlled inline for reliability */
  .popup { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); pointer-events:auto; }
  .modal { width:360px; background:#fff; border-radius:10px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,0.18); display:flex; flex-direction:column; gap:10px; position:relative; max-height:90vh; overflow:auto }
  .modal h2{margin:0;font-size:18px}
  .close{position:absolute;right:12px;top:10px;font-size:18px;cursor:pointer;border:none;background:none}
  input[type="text"],input[type="email"],input[type="password"],input[type="file"]{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd}
  .muted{font-size:13px;color:#666;margin:0}
  .row{display:flex;gap:8px}
  .progress-wrap{display:flex;align-items:center;gap:8px}
  progress{width:100%;height:12px;border-radius:6px;appearance:none}
  progress::-webkit-progress-bar{background:#eee;border-radius:6px}
  progress::-webkit-progress-value{background:var(--accent);border-radius:6px}
  .progress-text{min-width:48px;text-align:right;font-size:12px;color:#333}

  /* stacking to ensure edit is on top */
  #auth-popup{z-index:1000}
  #extra-popup{z-index:1010}
  #edit-popup{z-index:1100}

  #debug {position:fixed;right:12px;bottom:12px;background:#111;color:#fff;padding:8px;border-radius:8px;font-size:12px;z-index:1200;opacity:0.95}
  @media (max-width:420px){ .modal{width:92%} }
</style>
</head>
<body>

<header>
  <h1>Shipping Experts</h1>
  <div id="header-actions">
    <button id="signin-btn" aria-haspopup="dialog">Sign In</button>
    <div id="profile-circle" class="profile-circle" title="Open profile" aria-hidden="true" style="display:none">
      <img id="header-avatar" src="" alt="Avatar" style="display:none">
    </div>
  </div>
</header>

<!-- AUTH POPUP -->
<div id="auth-popup" class="popup" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Sign in">
    <button class="close" id="close-auth" title="Close">×</button>
    <h2>Sign In / Sign Up</h2>
    <input id="auth-email" type="email" placeholder="Email">
    <input id="auth-password" type="password" placeholder="Password">
    <div class="row">
      <button id="signup-btn">Sign Up</button>
      <button id="login-btn" class="ghost">Log In</button>
    </div>
    <p id="auth-status" class="muted"></p>
  </div>
</div>

<!-- EXTRA PROFILE -->
<div id="extra-popup" class="popup" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Extra profile">
    <button class="close" id="close-extra" title="Close">×</button>
    <h2>Set up your profile</h2>
    <input id="profile-username" type="text" placeholder="Username (optional)">
    <input id="profile-phone" type="text" placeholder="Phone (optional)">
    <input id="profile-avatar-upload" type="file" accept="image/*">
    <div id="avatar-progress-area" class="progress-wrap" style="display:none">
      <progress id="avatar-progress-bar" value="0" max="100"></progress>
      <div class="progress-text" id="avatar-progress-text">0%</div>
    </div>
    <div style="display:flex;justify-content:space-between;gap:8px">
      <button id="skip-profile" class="ghost">Skip</button>
      <button id="save-profile">Save</button>
    </div>
    <p id="profile-status" class="muted"></p>
  </div>
</div>

<!-- EDIT PROFILE -->
<div id="edit-popup" class="popup" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Edit profile">
    <button class="close" id="close-edit" title="Close">×</button>
    <h2>Edit Profile</h2>
    <input id="edit-fullname" type="text" placeholder="Full name">
    <input id="edit-username" type="text" placeholder="Username">
    <input id="edit-phone" type="text" placeholder="Phone">
    <input id="edit-email" type="email" placeholder="Email">
    <input id="edit-avatar-file" type="file" accept="image/*">
    <div style="display:flex;gap:8px">
      <button id="edit-save">Save</button>
      <button id="edit-cancel" class="ghost">Cancel</button>
    </div>
    <button id="signout-btn" style="margin-top:6px;background:#fff;border:1px solid #ddd">Sign Out</button>
    <p id="edit-status" class="muted"></p>
  </div>
</div>

<div id="debug">Debug: ready</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL = "https://gxcbliwbxrnhltdosfuj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4Y2JsaXdieHJuaGx0ZG9zZnVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5ODE4MDcsImV4cCI6MjA3MzU1NzgwN30.XsQR9vmnIknlcgUT4znIHGYjY_9s2hS8ZNIke9Dn7-E";

/* ---------- ELEMENTS ---------- */
const debugEl = document.getElementById('debug');

const signinBtn = document.getElementById('signin-btn');
const profileCircle = document.getElementById('profile-circle');
const headerAvatar = document.getElementById('header-avatar');

const authPopup = document.getElementById('auth-popup');
const extraPopup = document.getElementById('extra-popup');
const editPopup = document.getElementById('edit-popup');

const closeAuth = document.getElementById('close-auth');
const closeExtra = document.getElementById('close-extra');
const closeEdit = document.getElementById('close-edit');

const signupBtn = document.getElementById('signup-btn');
const loginBtn = document.getElementById('login-btn');
const authStatus = document.getElementById('auth-status');

const saveProfileBtn = document.getElementById('save-profile');
const skipProfileBtn = document.getElementById('skip-profile');
const profileStatus = document.getElementById('profile-status');
const avatarUploadInput = document.getElementById('profile-avatar-upload');
const avatarProgressArea = document.getElementById('avatar-progress-area');
const avatarProgressBar = document.getElementById('avatar-progress-bar');
const avatarProgressText = document.getElementById('avatar-progress-text');

const editFullname = document.getElementById('edit-fullname');
const editUsername = document.getElementById('edit-username');
const editPhone = document.getElementById('edit-phone');
const editEmail = document.getElementById('edit-email');
const editAvatarFile = document.getElementById('edit-avatar-file');
const editSaveBtn = document.getElementById('edit-save');
const editCancelBtn = document.getElementById('edit-cancel');
const signoutBtn = document.getElementById('signout-btn');
const editStatus = document.getElementById('edit-status');

/* ---------- HELPERS ---------- */
function logDebug(msg){
  console.log('[app]', msg);
  if (debugEl) debugEl.textContent = 'Debug: ' + msg;
}
function openModal(el){
  if(!el) return;
  el.style.display = 'flex';
  el.setAttribute('aria-hidden','false');
  // ensure overlay and modal are on top
  el.style.zIndex = 1100;
  // focus first input inside modal if present
  const first = el.querySelector('input, button, textarea, [tabindex]');
  if(first) try{ first.focus(); }catch(e){}
}
function closeModal(el){
  if(!el) return;
  el.style.display = 'none';
  el.setAttribute('aria-hidden','true');
}
/* click overlay to close */
document.querySelectorAll('.popup').forEach(p => {
  p.addEventListener('click', e => {
    if (e.target === p) closeModal(p);
  });
});

/* ---------- UI-first handlers (guaranteed) ---------- */
signinBtn.addEventListener('click', () => {
  authStatus.textContent = '';
  document.getElementById('auth-email').value = '';
  document.getElementById('auth-password').value = '';
  logDebug('Sign In clicked — UI opened');
  openModal(authPopup);
});
closeAuth.addEventListener('click', () => closeModal(authPopup));
closeExtra.addEventListener('click', () => closeModal(extraPopup));
closeEdit.addEventListener('click', () => closeModal(editPopup));
document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('.popup').forEach(p => closeModal(p)); });

/* ---------- supabase single init ---------- */
let supabaseClient = null;
function initSupabase(){
  if (supabaseClient) return;
  if (!window.supabase) {
    logDebug('Supabase lib not loaded yet (UI still works).');
    return;
  }
  supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  logDebug('Supabase client initialized');
  hookAuthHandlers();
  postInitLoadUser();
}
initSupabase();
window.addEventListener('load', initSupabase);
setTimeout(initSupabase, 900);

/* ---------- auth handlers ---------- */
function hookAuthHandlers(){
  if (!supabaseClient) return;

  signupBtn.addEventListener('click', async () => {
    authStatus.textContent = 'Processing…';
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;
    if (!email || !password) { authStatus.textContent = 'Email and password required.'; return; }
    logDebug('Signing up ' + email);
    const { data, error } = await supabaseClient.auth.signUp({ email, password });
    if (error) { authStatus.textContent = error.message; logDebug('signup error: ' + error.message); return; }
    if (data?.user?.id) await supabaseClient.from('profiles').insert({ id: data.user.id }).catch(()=>{});
    authStatus.textContent = '';
    closeModal(authPopup);
    document.getElementById('profile-username').value = '';
    document.getElementById('profile-phone').value = '';
    avatarUploadInput.value = '';
    avatarProgressBar.value = 0;
    avatarProgressText.textContent = '0%';
    avatarProgressArea.style.display = 'none';
    openModal(extraPopup);
  });

  loginBtn.addEventListener('click', async () => {
    authStatus.textContent = 'Signing in…';
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;
    if (!email || !password) { authStatus.textContent = 'Email and password required.'; return; }
    try {
      logDebug('Signing in ' + email);
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) { authStatus.textContent = error.message; logDebug('signin error: ' + error.message); return; }
      authStatus.textContent = '';
      closeModal(authPopup);
      if (data?.user) {
        await updateHeaderAndState(data.user);
        await loadProfileIntoHeader(data.user.id);
      }
    } catch (err) {
      authStatus.textContent = 'Sign in error: ' + (err?.message || err);
    }
  });

  supabaseClient.auth.onAuthStateChange((event, session) => {
    logDebug('auth event: ' + event);
    const u = session?.user ?? null;
    if (u) updateHeaderAndState(u);
    else hideProfileUI();
  });
}

/* ---------- upload helper (keep slashes) ---------- */
function encodePathAllowSlashes(path){
  return path.split('/').map(seg => encodeURIComponent(seg)).join('/');
}
function uploadFileWithProgress(file, bucket, path, onProgress){
  const encodedPath = encodePathAllowSlashes(path);
  const url = `${SUPABASE_URL}/storage/v1/object/${bucket}/${encodedPath}`;
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('PUT', url);
    try {
      xhr.setRequestHeader('Authorization', `Bearer ${SUPABASE_ANON_KEY}`);
      if (file && file.type) xhr.setRequestHeader('Content-Type', file.type);
      xhr.setRequestHeader('x-upsert', 'true');
    } catch(e){ /* ignore */ }

    xhr.upload.onprogress = ev => {
      if (ev.lengthComputable && typeof onProgress === 'function') {
        const pct = Math.round((ev.loaded / ev.total) * 100);
        onProgress(pct);
      }
    };
    xhr.onload = () => {
      const body = xhr.responseText || '';
      if (xhr.status >= 200 && xhr.status < 300) resolve({ status: xhr.status, body });
      else reject(new Error(`Upload failed (${xhr.status}): ${body || xhr.statusText}`));
    };
    xhr.onerror = () => reject(new Error('Network error during upload'));
    xhr.send(file);
  });
}

/* ---------- EXTRA PROFILE SAVE ---------- */
saveProfileBtn.addEventListener('click', async () => {
  profileStatus.textContent = '';
  if (!supabaseClient) { profileStatus.textContent = 'Auth client not ready — try again.'; logDebug('save attempted but client missing'); return; }
  const userResp = await supabaseClient.auth.getUser();
  const user = userResp?.data?.user;
  if (!user) { profileStatus.textContent = 'Sign in first.'; return; }

  const username = document.getElementById('profile-username').value.trim() || null;
  const phone = document.getElementById('profile-phone').value.trim() || null;
  const file = avatarUploadInput.files[0] || null;

  let avatarUrl = null;
  if (file) {
    avatarProgressArea.style.display = 'flex';
    avatarProgressBar.value = 0;
    avatarProgressText.textContent = '0%';
    const path = `public/${user.id}.png`;
    try {
      await uploadFileWithProgress(file, 'avatars', path, pct => {
        avatarProgressBar.value = pct;
        avatarProgressText.textContent = pct + '%';
      });
      const { data: pub } = await supabaseClient.storage.from('avatars').getPublicUrl(path);
      avatarUrl = pub?.publicUrl || `${SUPABASE_URL}/storage/v1/object/public/avatars/${encodeURIComponent(path)}`;
    } catch (err) {
      const msg = err?.message || err;
      profileStatus.textContent = 'Upload failed: ' + msg;
      logDebug('avatar upload failed: ' + msg);
      return;
    }
  }

  try {
    await supabaseClient.from('profiles').update({ username, phone, avatar_url: avatarUrl || null }).eq('id', user.id);
  } catch(e) {
    profileStatus.textContent = 'Profile save failed: ' + (e?.message || e);
    logDebug('profile update failed: ' + (e?.message || e));
  }

  closeModal(extraPopup);
  if (avatarUrl) {
    headerAvatar.src = avatarUrl;
    headerAvatar.style.display = 'block';
  }
  await updateHeaderAndState(user);
});
skipProfileBtn.addEventListener('click', () => closeModal(extraPopup));

/* ---------- HEADER / EDIT flows ---------- */
function hideProfileUI(){ signinBtn.style.display = 'inline-block'; profileCircle.style.display = 'none'; headerAvatar.style.display = 'none'; profileCircle.setAttribute('aria-hidden','true'); }
function showProfileUI(){ signinBtn.style.display = 'none'; profileCircle.style.display = 'flex'; profileCircle.setAttribute('aria-hidden','false'); }

async function loadProfileIntoHeader(userId){
  if (!supabaseClient) { logDebug('Cannot load profile — client missing'); return; }
  try {
    const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', userId).single();
    if (profile?.avatar_url) {
      headerAvatar.src = profile.avatar_url;
      headerAvatar.style.display = 'block';
    } else {
      headerAvatar.style.display = 'none';
    }
    showProfileUI();
  } catch (err) {
    logDebug('loadProfile error: ' + (err?.message || err));
  }
}

async function updateHeaderAndState(user){
  if (!supabaseClient || !user) { hideProfileUI(); return; }
  await loadProfileIntoHeader(user.id);
}

/* clicking profile circle reliably opens edit modal */
profileCircle.addEventListener('click', async () => {
  logDebug('Profile circle clicked — checking auth & opening edit modal');
  if (!supabaseClient) {
    logDebug('Supabase client missing while opening edit popup; showing UI anyway');
    openModal(editPopup);
    return;
  }
  const resp = await supabaseClient.auth.getUser();
  const user = resp?.data?.user;
  if (!user) { openModal(authPopup); return; }

  const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single().catch(()=>({ data:null }));
  editFullname.value = profile?.full_name || '';
  editUsername.value = profile?.username || '';
  editPhone.value = profile?.phone || '';
  editEmail.value = user.email || '';
  editAvatarFile.value = '';
  // Force show: set display and z-index
  openModal(editPopup);
});

/* edit save */
editSaveBtn.addEventListener('click', async () => {
  editStatus.textContent = '';
  if (!supabaseClient) { editStatus.textContent = 'Auth client not ready.'; return; }
  const userResp = await supabaseClient.auth.getUser();
  const user = userResp?.data?.user;
  if (!user) { editStatus.textContent = 'Not signed in.'; return; }

  const fullname = editFullname.value.trim() || null;
  const username = editUsername.value.trim() || null;
  const phone = editPhone.value.trim() || null;
  const file = editAvatarFile.files[0] || null;

  let avatarUrl = null;
  if (file) {
    avatarProgressArea.style.display = 'flex';
    avatarProgressBar.value = 0;
    avatarProgressText.textContent = '0%';
    const path = `public/${user.id}.png`;
    try {
      await uploadFileWithProgress(file, 'avatars', path, pct => {
        avatarProgressBar.value = pct;
        avatarProgressText.textContent = pct + '%';
      });
      const { data: pub } = await supabaseClient.storage.from('avatars').getPublicUrl(path);
      avatarUrl = pub?.publicUrl || `${SUPABASE_URL}/storage/v1/object/public/avatars/${encodeURIComponent(path)}`;
    } catch (err) {
      const msg = err?.message || err;
      editStatus.textContent = 'Upload failed: ' + msg;
      logDebug('edit avatar upload failed: ' + msg);
      return;
    }
  }

  try {
    await supabaseClient.from('profiles').update({ full_name: fullname, username, phone, avatar_url: avatarUrl || undefined }).eq('id', user.id);
  } catch (e) {
    editStatus.textContent = 'Save failed: ' + (e?.message || e);
    logDebug('profile update failed: ' + (e?.message || e));
  }

  if (avatarUrl) {
    headerAvatar.src = avatarUrl;
    headerAvatar.style.display = 'block';
  }
  closeModal(editPopup);
  await updateHeaderAndState(user);
});

/* sign out */
signoutBtn.addEventListener('click', async () => {
  if (!supabaseClient) { hideProfileUI(); closeModal(editPopup); return; }
  await supabaseClient.auth.signOut();
  hideProfileUI();
  closeModal(editPopup);
});

/* ---------- On load: sync auth state ---------- */
async function postInitLoadUser(){
  if (!supabaseClient) return;
  try {
    const { data } = await supabaseClient.auth.getUser();
    const user = data?.user;
    if (user) {
      logDebug('Signed in as ' + (user.email || user.id));
      await updateHeaderAndState(user);
    } else {
      logDebug('No signed-in user');
      hideProfileUI();
    }
  } catch (err) {
    logDebug('postInit load user error: ' + (err?.message || err));
  }
}
</script>
</body>
</html>
