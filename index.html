<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shipping Experts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family:Arial,sans-serif; }
    header { background:#FF6700; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; color:#fff; }
    .profile-circle { width:40px; height:40px; border-radius:50%; background:#000; cursor:pointer; overflow:hidden; }
    .hidden { display:none; }
    #auth-modal, #edit-profile-modal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);
      justify-content:center; align-items:center;
    }
    .modal-content {
      background:#fff; padding:20px; border-radius:8px; width:300px; position:relative;
    }
    .close-btn { position:absolute; top:10px; right:10px; cursor:pointer; }
    #profile-avatar { width:100%; height:100%; object-cover; }
  </style>
</head>
<body>
  <header>
    <h1>Shipping Experts</h1>
    <div id="header-actions">
      <button id="signin-btn">Sign In</button>
      <!-- Profile Circle -->
      <div id="profile-circle" class="profile-circle hidden">
        <img id="profile-avatar" src="" alt="Profile" class="hidden">
      </div>
    </div>
  </header>

  <!-- Auth Modal -->
  <div id="auth-modal">
    <div class="modal-content">
      <span class="close-btn" id="auth-close">×</span>
      <h2>Sign In / Sign Up</h2>
      <input id="auth-email" type="email" placeholder="Email"><br>
      <input id="auth-password" type="password" placeholder="Password"><br>
      <input id="auth-username" type="text" placeholder="Username"><br>
      <input id="auth-phone" type="text" placeholder="Phone"><br>
      <button id="signup-submit">Sign Up</button>
      <button id="signin-submit">Sign In</button>
      <p id="auth-status"></p>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div id="edit-profile-modal">
    <div class="modal-content">
      <span class="close-btn" id="edit-profile-close">×</span>
      <h2>Edit Profile</h2>
      <input id="edit-fullname" type="text" placeholder="Full Name"><br>
      <input id="edit-username" type="text" placeholder="Username"><br>
      <input id="edit-phone" type="text" placeholder="Phone"><br>
      <input id="edit-email" type="email" placeholder="Email"><br>
      <input id="edit-avatar" type="file"><br>
      <button id="edit-profile-save">Save</button>
      <button id="edit-profile-cancel">Cancel</button>
      <button id="signout-btn">Sign Out</button>
      <p id="profile-status"></p>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://gxcbliwbxrnhltdosfuj.supabase.co"
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY"
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const signinBtn = document.getElementById('signin-btn')
    const profileCircle = document.getElementById('profile-circle')
    const avatarImg = document.getElementById('profile-avatar')
    const authModal = document.getElementById('auth-modal')
    const editProfileModal = document.getElementById('edit-profile-modal')

    // Open/close modals
    signinBtn.addEventListener('click', () => authModal.style.display = 'flex')
    document.getElementById('auth-close').addEventListener('click', () => authModal.style.display = 'none')
    profileCircle.addEventListener('click', () => editProfileModal.style.display = 'flex')
    document.getElementById('edit-profile-close').addEventListener('click', () => editProfileModal.style.display = 'none')
    document.getElementById('edit-profile-cancel').addEventListener('click', () => editProfileModal.style.display = 'none')

    // Sign up
    document.getElementById('signup-submit').addEventListener('click', async () => {
      const email = document.getElementById('auth-email').value
      const password = document.getElementById('auth-password').value
      const username = document.getElementById('auth-username').value
      const phone = document.getElementById('auth-phone').value

      if(!email || !password || !username || !phone){
        document.getElementById('auth-status').textContent = 'All fields are required'
        return
      }

      const { data, error } = await supabaseClient.auth.signUp({
        email, password,
        options: { data: { username, phone }, emailRedirectTo: window.location.href }
      })

      if(error){
        document.getElementById('auth-status').textContent = error.message
      } else {
        const { error: profileError } = await supabaseClient.from('profiles').upsert({
          id: data.user.id, username, phone
        })
        document.getElementById('auth-status').textContent = profileError ? profileError.message : 'Signed up successfully! Please confirm email.'
      }
    })

    // Sign in
    document.getElementById('signin-submit').addEventListener('click', async () => {
      const email = document.getElementById('auth-email').value
      const password = document.getElementById('auth-password').value
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password })

      if(error){
        document.getElementById('auth-status').textContent = error.message
      } else {
        authModal.style.display = 'none'
        updateHeaderProfile(data.user)

        // Fetch profile and update circle
        const { data: profile } = await supabaseClient
          .from("profiles")
          .select("*")
          .eq("id", data.user.id)
          .single()
        if(profile) updateProfileCircle(profile)
      }
    })

    // Sign out
    document.getElementById('signout-btn').addEventListener('click', async () => {
      const { error } = await supabaseClient.auth.signOut()
      if(error) console.error('Sign out error:', error.message)
      else {
        editProfileModal.style.display = 'none'
        updateHeaderProfile(null)
      }
    })

    // Save profile changes
    document.getElementById('edit-profile-save').addEventListener('click', async () => {
      const user = (await supabaseClient.auth.getUser()).data.user
      const fullname = document.getElementById('edit-fullname').value
      const username = document.getElementById('edit-username').value
      const phone = document.getElementById('edit-phone').value
      const newEmail = document.getElementById('edit-email').value
      const avatarFile = document.getElementById('edit-avatar').files[0]

      // Update profiles table
      const { error: profileError } = await supabaseClient.from('profiles').upsert({
        id: user.id, full_name: fullname, username, phone
      })
      if(profileError) {
        document.getElementById('profile-status').textContent = profileError.message
        return
      }

      // Update email
      if(newEmail){
        const { error: emailError } = await supabaseClient.auth.updateUser({ email: newEmail })
        if(emailError){
          document.getElementById('profile-status').textContent = emailError.message
          return
        }
      }

      // Upload avatar
      if(avatarFile){
        const { error: avatarError } = await supabaseClient.storage
          .from('avatars')
          .upload(`public/${user.id}.png`, avatarFile, { upsert: true })

        if(avatarError){
          document.getElementById('profile-status').textContent = "Avatar upload error: " + avatarError.message
          return
        }

        // Save avatar URL in profile
        const { data: { publicUrl } } = supabaseClient.storage
          .from("avatars")
          .getPublicUrl(`public/${user.id}.png`)

        await supabaseClient.from("profiles").upsert({
          id: user.id, avatar_url: publicUrl
        })

        avatarImg.src = publicUrl
        avatarImg.classList.remove("hidden")
        profileCircle.classList.remove("bg-black")
      }

      document.getElementById('profile-status').textContent = 'Profile updated successfully!'
    })

    // Update header (sign in / profile circle)
    function updateHeaderProfile(user){
      if(user){
        signinBtn.classList.add('hidden')
        profileCircle.classList.remove('hidden')
      } else {
        signinBtn.classList.remove('hidden')
        profileCircle.classList.add('hidden')
      }
    }

    // Show profile avatar in header
    function updateProfileCircle(profile) {
      if (profile && profile.avatar_url) {
        avatarImg.src = profile.avatar_url
        avatarImg.classList.remove("hidden")
        profileCircle.classList.remove("bg-black")
      } else {
        avatarImg.classList.add("hidden")
        profileCircle.classList.add("bg-black")
      }
      profileCircle.classList.remove("hidden")
    }

    // On page load, check if logged in
    supabaseClient.auth.getUser().then(async ({ data }) => {
      const user = data.user
      updateHeaderProfile(user)
      if(user){
        const { data: profile } = await supabaseClient
          .from("profiles")
          .select("*")
          .eq("id", user.id)
          .single()
        if(profile) updateProfileCircle(profile)
      }
    })
  </script>
</body>
</html>
