<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shipping Experts — Account</title>
<link rel="stylesheet" href="" />
<style>
  :root{
    --accent:#FF6700;
    --bg:#f4f6f8;
    --card:#ffffff;
    --muted:#666;
    --max-w:980px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;padding:0;background:var(--bg);color:#111}
  header{background:var(--accent);color:#fff;padding:12px 20px;display:flex;align-items:center;justify-content:space-between}
  h1{margin:0;font-weight:600;font-size:18px}
  #header-actions{display:flex;gap:12px;align-items:center}
  button{cursor:pointer;border:0;padding:8px 12px;border-radius:8px;background:#fff;color:#111;font-weight:600}
  .ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.18)}
  .profile-circle{width:44px;height:44px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#000;cursor:pointer;border:2px solid rgba(255,255,255,0.12)}
  .profile-circle img{width:100%;height:100%;object-fit:cover;display:block}

  /* Debug small box */
  #debug {position:fixed;right:14px;bottom:14px;background:#111;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;z-index:999999;opacity:0.95}

  /* Full page account overlay */
  #account-page {
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background: rgba(6,9,12,0.55); z-index:99990; padding:24px;
  }
  .account-shell {
    width:100%; max-width:var(--max-w); background:var(--card); border-radius:12px; box-shadow:0 20px 60px rgba(2,6,23,0.25);
    padding:26px; display:flex; flex-direction:column; gap:20px; align-items:center; position:relative;
  }
  .account-shell .close-full {
    position:absolute; right:18px; top:16px; background:none; border:0; font-size:20px; cursor:pointer;
  }
  .account-title { font-size:22px; font-weight:700; margin:0; text-align:center; }
  .sections { width:100%; display:flex; flex-direction:column; gap:18px; align-items:center; }

  .section {
    width:100%; background: #fbfbfd; border-radius:10px; padding:16px; display:flex; flex-direction:column; gap:12px; align-items:center; border:1px solid rgba(10,10,10,0.03);
  }
  .section h3 { margin:0; font-size:16px; font-weight:700; text-align:center; }
  .field-grid { width:100%; display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .field { display:flex; flex-direction:column; gap:6px; }
  .field label { font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:0.6px; }
  .field input[type="text"], .field input[type="email"], .field input[type="password"], .field input[type="tel"] {
    padding:10px 12px; border-radius:8px; border:1px solid #e6e9ef; background:#fff; font-size:14px;
  }

  /* avatar preview */
  .avatar-wrap { display:flex; gap:12px; align-items:center; justify-content:center; }
  .avatar-preview { width:96px; height:96px; border-radius:12px; overflow:hidden; background:#eee; display:flex; align-items:center; justify-content:center; border:1px solid rgba(0,0,0,0.06); }
  .avatar-preview img { width:100%; height:100%; object-fit:cover; display:block; }

  /* small buttons next to each other */
  .btn-row { display:flex; gap:10px; align-items:center; }

  /* Activity & history placeholders */
  .history-list { width:100%; display:flex; flex-direction:column; gap:8px; max-height:220px; overflow:auto; padding-right:6px; }
  .history-item { display:flex; justify-content:space-between; gap:8px; padding:10px; border-radius:8px; background:#fff; border:1px solid rgba(0,0,0,0.03); align-items:center; }
  .muted-small { color:var(--muted); font-size:13px; }

  /* toggles */
  .toggle { display:inline-flex; align-items:center; gap:8px; }
  .switch { width:44px; height:24px; background:#eef2f6; border-radius:16px; position:relative; cursor:pointer; }
  .switch .dot { width:18px; height:18px; background:#fff; border-radius:50%; position:absolute; top:3px; left:3px; transition:all .18s ease; box-shadow:0 4px 12px rgba(2,6,23,0.08); }
  .switch.on { background:var(--accent); }
  .switch.on .dot { left:23px; }

  /* Tabs / Filters */
  .tabs { display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; }
  .tab { padding:8px 12px; background:#fff; border-radius:999px; border:1px solid rgba(0,0,0,0.04); cursor:pointer; font-weight:600; }
  .tab.active { background:var(--accent); color:#fff; }

  /* bottom-right Save */
  #save-btn { position:fixed; right:28px; bottom:28px; z-index:99999; padding:12px 18px; background:var(--accent); color:#fff; border-radius:12px; border:0; font-weight:700; box-shadow:0 8px 22px rgba(255,103,0,0.18); cursor:pointer; }

  /* small edit modal (kept) */
  .mini-popup { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:100000; }
  .mini-modal { width:340px; background:#fff; border-radius:10px; padding:18px; box-shadow:0 10px 60px rgba(2,6,23,0.25); display:flex; flex-direction:column; gap:10px; }

  /* responsive */
  @media (max-width:880px) {
    .field-grid { grid-template-columns: 1fr; }
    .account-shell { padding:16px; }
    #save-btn{ right:12px; bottom:12px }
  }

</style>
</head>
<body>
<header>
  <h1>Shipping Experts</h1>
  <div id="header-actions">
    <button id="signin-btn">Sign In</button>
    <div id="profile-circle" class="profile-circle" title="Open account" style="display:none">
      <img id="header-avatar" src="" alt="Avatar" style="display:none">
    </div>
  </div>
</header>

<!-- DEBUG -->
<div id="debug">Debug: ready</div>

<!-- FULL ACCOUNT PAGE (overlay, centered) -->
<div id="account-page" aria-hidden="true">
  <div class="account-shell" role="dialog" aria-modal="true" aria-label="Account page">
    <button class="close-full" id="close-account">✕</button>
    <div class="account-title">Account</div>

    <div class="sections">

      <!-- ACCOUNT SECTION -->
      <section class="section" id="section-account" style="max-width:880px">
        <h3>ACCOUNT</h3>
        <div class="field-grid">
          <div class="field">
            <label>Full Name</label>
            <input id="acc-fullname" type="text" placeholder="Full name">
          </div>
          <div class="field">
            <label>Username</label>
            <input id="acc-username" type="text" placeholder="Username">
          </div>

          <div class="field">
            <label>Email</label>
            <input id="acc-email" type="email" placeholder="Email">
          </div>
          <div class="field">
            <label>Phone</label>
            <input id="acc-phone" type="tel" placeholder="Phone">
          </div>

          <div class="field">
            <label>Password</label>
            <input id="acc-password" type="password" placeholder="••••••••">
          </div>
          <div class="field">
            <label>Profile Image</label>
            <div class="avatar-wrap">
              <div class="avatar-preview" id="acc-avatar-preview"><img id="acc-avatar-img" src="" alt="" style="display:none"></div>
              <div style="display:flex;flex-direction:column;gap:8px">
                <input id="acc-avatar-input" type="file" accept="image/*">
                <div style="display:flex;gap:8px">
                  <button id="open-edit-mini" style="background:#111;color:#fff">EDIT</button>
                  <button id="signout-page" class="ghost" style="background:transparent">Sign out</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ACTIVITY & HISTORY -->
      <section class="section" id="section-history" style="max-width:880px">
        <h3>ACTIVITY &amp; HISTORY</h3>
        <div style="width:100%; display:flex; gap:16px; flex-direction:column; align-items:center;">
          <div style="width:100%; display:flex; gap:12px; flex-wrap:wrap; justify-content:center;">
            <div style="min-width:200px; padding:12px; border-radius:8px; background:#fff; text-align:center; border:1px solid rgba(0,0,0,0.03)">
              <div style="font-weight:700">Order History</div>
              <div class="muted-small">Past bookings & statuses</div>
            </div>
            <div style="min-width:200px; padding:12px; border-radius:8px; background:#fff; text-align:center; border:1px solid rgba(0,0,0,0.03)">
              <div style="font-weight:700">Tracking</div>
              <div class="muted-small">Active shipments snapshot</div>
            </div>
            <div style="min-width:200px; padding:12px; border-radius:8px; background:#fff; text-align:center; border:1px solid rgba(0,0,0,0.03)">
              <div style="font-weight:700">Invoices</div>
              <div class="muted-small">PDF receipts</div>
            </div>
          </div>

          <div style="width:100%; display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
            <div style="flex:1; min-width:260px">
              <div style="font-weight:700; margin-bottom:8px">Order/Shipment History</div>
              <div class="history-list" id="history-list">
                <!-- placeholder items -->
                <div class="history-item"><div><strong>#A1234</strong><div class="muted-small">Delivered</div></div><div class="muted-small">Oct 1</div></div>
                <div class="history-item"><div><strong>#B897</strong><div class="muted-small">In transit</div></div><div class="muted-small">Oct 7</div></div>
                <div class="history-item"><div><strong>#C551</strong><div class="muted-small">Pickup scheduled</div></div><div class="muted-small">Oct 10</div></div>
              </div>
            </div>

            <div style="flex:1; min-width:260px">
              <div style="font-weight:700; margin-bottom:8px">Invoices / Billing</div>
              <div class="history-list">
                <div class="history-item"><div>#INV-001</div><div><button class="ghost" onclick="alert('Download placeholder')">Download PDF</button></div></div>
                <div class="history-item"><div>#INV-002</div><div><button class="ghost" onclick="alert('Download placeholder')">Download PDF</button></div></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- NOTIFICATIONS & SECURITY -->
      <section class="section" id="section-security" style="max-width:880px">
        <h3>NOTIFICATIONS &amp; SECURITY</h3>

        <div style="width:100%;display:flex;gap:12px;flex-direction:column;align-items:center;">
          <div style="width:100%;display:flex;justify-content:center;">
            <div style="width:640px;display:flex;flex-direction:column;gap:12px;">
              <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#fff;border-radius:8px;border:1px solid rgba(0,0,0,0.03)">
                <div>
                  <div style="font-weight:700">Password & Login</div>
                  <div class="muted-small">Change password and setup 2FA</div>
                </div>
                <div>
                  <button class="ghost" onclick="document.getElementById('acc-password').focus()">Change</button>
                </div>
              </div>

              <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#fff;border-radius:8px;border:1px solid rgba(0,0,0,0.03)">
                <div>
                  <div style="font-weight:700">Communication Preferences</div>
                  <div class="muted-small">Email / SMS notifications</div>
                </div>
                <div class="toggle">
                  <div id="pref-toggle" class="switch"><div class="dot"></div></div>
                </div>
              </div>

              <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#fff;border-radius:8px;border:1px solid rgba(0,0,0,0.03)">
                <div>
                  <div style="font-weight:700">Login Activity / Devices</div>
                  <div class="muted-small">Recent devices & locations</div>
                </div>
                <div><button class="ghost" onclick="alert('Showing login activity (placeholder)')">View</button></div>
              </div>

              <div style="padding:8px; display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap;">
                <div class="tabs" id="tabs">
                  <div class="tab active" data-filter="all">All</div>
                  <div class="tab" data-filter="shipments">Shipments</div>
                  <div class="tab" data-filter="messages">Messages</div>
                  <div class="tab" data-filter="promos">Promos</div>
                  <div class="tab" data-filter="system">System</div>
                </div>
              </div>

              <div style="background:#fff;border-radius:8px;border:1px solid rgba(0,0,0,0.03);padding:12px;">
                <div style="font-weight:700">Inbox (Unread at top)</div>
                <div id="inbox-list" style="margin-top:8px;display:flex;flex-direction:column;gap:8px;">
                  <div style="padding:8px;border-radius:8px;background:#fff;border:1px solid rgba(0,0,0,0.03)"><strong>New tracking update</strong><div class="muted-small">Shipment #B897 — Arriving tomorrow</div></div>
                  <div style="padding:8px;border-radius:8px;background:#fff;border:1px solid rgba(0,0,0,0.03)"><div class="muted-small">Promo: Save 10% on your next booking</div></div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </section>

    </div>

    <button id="save-btn">Save</button>
  </div>
</div>

<!-- small edit modal (opens on top of full page if desired) -->
<div id="mini-edit" class="mini-popup" style="display:none" aria-hidden="true">
  <div class="mini-modal">
    <button class="close" id="mini-close">✕</button>
    <h3>Edit Profile (Quick)</h3>
    <input id="mini-fullname" type="text" placeholder="Full name">
    <input id="mini-username" type="text" placeholder="Username">
    <input id="mini-phone" type="text" placeholder="Phone">
    <input id="mini-email" type="email" placeholder="Email">
    <input id="mini-avatar-file" type="file" accept="image/*">
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="mini-save">Save</button>
      <button id="mini-cancel" class="ghost">Cancel</button>
    </div>
    <p id="mini-status" class="muted-small"></p>
  </div>
</div>

<!-- Include Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
/* CONFIG */
const SUPABASE_URL = "https://gxcbliwbxrnhltdosfuj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4Y2JsaXdieHJuaGx0ZG9zZnVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5ODE4MDcsImV4cCI6MjA3MzU1NzgwN30.XsQR9vmnIknlcgUT4znIHGYjY_9s2hS8ZNIke9Dn7-E";

let supabaseClient = null;
function initSupabase(){
  if (supabaseClient) return;
  if (!window.supabase) {
    debug('Supabase lib not loaded yet — UI still works');
    return;
  }
  supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  debug('Supabase client initialized');
  bindAuthHandlers();
  postInitLoadUser();
}
setTimeout(initSupabase, 300);
window.addEventListener('load', initSupabase);

/* Elements */
const debugEl = document.getElementById('debug');
const signinBtn = document.getElementById('signin-btn');
const profileCircle = document.getElementById('profile-circle');
const headerAvatar = document.getElementById('header-avatar');

const accountPage = document.getElementById('account-page');
const closeAccount = document.getElementById('close-account');
const saveBtn = document.getElementById('save-btn');

const accFullname = document.getElementById('acc-fullname');
const accUsername = document.getElementById('acc-username');
const accEmail = document.getElementById('acc-email');
const accPhone = document.getElementById('acc-phone');
const accPassword = document.getElementById('acc-password');
const accAvatarInput = document.getElementById('acc-avatar-input');
const accAvatarImg = document.getElementById('acc-avatar-img');
const accAvatarPreview = document.getElementById('acc-avatar-preview');

const openEditMiniBtn = document.getElementById('open-edit-mini');
const miniPopup = document.getElementById('mini-edit');
const miniClose = document.getElementById('mini-close');
const miniCancel = document.getElementById('mini-cancel');
const miniSave = document.getElementById('mini-save');

const miniFull = document.getElementById('mini-fullname');
const miniUser = document.getElementById('mini-username');
const miniPhone = document.getElementById('mini-phone');
const miniEmail = document.getElementById('mini-email');
const miniAvatarFile = document.getElementById('mini-avatar-file');
const miniStatus = document.getElementById('mini-status');

const signoutPageBtn = document.getElementById('signout-page');

/* Helpers */
function debug(msg){ console.log('[app]', msg); if (debugEl) debugEl.textContent = 'Debug: ' + msg; }
function showAccountPage(){ accountPage.style.display = 'flex'; accountPage.setAttribute('aria-hidden','false'); }
function hideAccountPage(){ accountPage.style.display = 'none'; accountPage.setAttribute('aria-hidden','true'); }
function showMini(){ miniPopup.style.display = 'flex'; miniPopup.setAttribute('aria-hidden','false'); }
function hideMini(){ miniPopup.style.display = 'none'; miniPopup.setAttribute('aria-hidden','true'); }

/* UI-first handlers (Sign in opens auth UI below) */
signinBtn.addEventListener('click', () => {
  showAuthUI();
  debug('Sign In clicked — opening auth UI');
});
profileCircle.addEventListener('click', async () => {
  debug('Profile circle clicked — opening account page');
  // When clicked, open full account page; populate fields
  if (!supabaseClient) {
    debug('Supabase client missing — showing account UI anyway');
    showAccountPage();
    return;
  }
  try {
    const { data: userData } = await supabaseClient.auth.getUser();
    const user = userData?.user;
    if (!user) { debug('No signed-in user — opening sign-in'); showAuthUI(); return; }
    // load profile row safely with try/catch
    try {
      const res = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
      if (res.error) {
        debug('load profile returned error: ' + (res.error.message || res.error));
      }
      const profile = res.data || {};
      // populate fields
      accFullname.value = profile.full_name || '';
      accUsername.value = profile.username || '';
      accEmail.value = user.email || '';
      accPhone.value = profile.phone || '';
      if (profile.avatar_url) {
        accAvatarImg.src = profile.avatar_url;
        accAvatarImg.style.display = 'block';
      } else {
        accAvatarImg.style.display = 'none';
      }
    } catch (qerr) {
      debug('profile query error: ' + (qerr.message || qerr));
      // still open page
    }
    showAccountPage();
  } catch (err) {
    debug('profile click handler error: ' + (err?.message || err));
    showAccountPage();
  }
});

/* Close account page */
closeAccount.addEventListener('click', () => { hideAccountPage(); debug('Account closed'); });

/* Avatar preview handling (account page) */
accAvatarInput.addEventListener('change', (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  accAvatarImg.src = url;
  accAvatarImg.style.display = 'block';
  // keep the preview object URL until upload/save clears it
});

/* OPEN mini edit modal from the account page */
openEditMiniBtn.addEventListener('click', async () => {
  // populate mini fields from account inputs
  miniFull.value = accFullname.value || '';
  miniUser.value = accUsername.value || '';
  miniPhone.value = accPhone.value || '';
  miniEmail.value = accEmail.value || '';
  miniStatus.textContent = '';
  showMini();
});
miniClose.addEventListener('click', () => hideMini());
miniCancel.addEventListener('click', () => hideMini());

/* Mini save: writes to profiles (like the small edit modal did before) */
miniSave.addEventListener('click', async () => {
  miniStatus.textContent = '';
  if (!supabaseClient) { miniStatus.textContent = 'Auth client not ready'; return; }

  const { data: userData } = await supabaseClient.auth.getUser();
  const user = userData?.user;
  if (!user) { miniStatus.textContent = 'Not signed in'; return; }

  const fullname = miniFull.value.trim() || null;
  const username = miniUser.value.trim() || null;
  const phone = miniPhone.value.trim() || null;
  // handle avatar upload if chosen in mini
  const file = miniAvatarFile.files[0] || null;

  let avatarUrl = null;
  if (file) {
    miniStatus.textContent = 'Uploading avatar…';
    try {
      const path = `public/${user.id}.png`;
      await uploadFileWithProgress(file, 'avatars', path, pct => {
        miniStatus.textContent = 'Uploading: ' + pct + '%';
      });
      const { data: pub } = await supabaseClient.storage.from('avatars').getPublicUrl(path);
      avatarUrl = pub?.publicUrl || `${SUPABASE_URL}/storage/v1/object/public/avatars/${encodeURIComponent(path)}`;
    } catch (err) {
      miniStatus.textContent = 'Upload failed: ' + (err?.message || err);
      debug('mini avatar upload failed: ' + (err?.message || err));
      return;
    }
  }

  // Update profile row
  try {
    const updateRes = await supabaseClient.from('profiles').update({
      full_name: fullname,
      username,
      phone,
      avatar_url: avatarUrl || undefined
    }).eq('id', user.id);

    if (updateRes.error) {
      // Attach clear RLS hint if present
      miniStatus.textContent = 'Save failed: ' + updateRes.error.message;
      debug('mini profile update error: ' + updateRes.error.message);
      if ((updateRes.error.message || '').toLowerCase().includes('row-level')) {
        miniStatus.textContent += ' — row-level security prevented update. Ensure your table policy allows authenticated users to update their row (auth.uid() = id).';
      }
      return;
    }
  } catch (e) {
    miniStatus.textContent = 'Save failed: ' + (e?.message || e);
    debug('mini profile update thrown: ' + (e?.message || e));
    return;
  }

  miniStatus.textContent = 'Saved';
  hideMini();
  // refresh header/profile
  await postInitLoadUser();
});

/* SAVE button on full account page: updates profile & uploads if needed */
saveBtn.addEventListener('click', async () => {
  if (!supabaseClient) { alert('Auth client not ready'); return; }
  const { data: userData } = await supabaseClient.auth.getUser();
  const user = userData?.user;
  if (!user) { alert('Please sign in first'); return; }

  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving…';

  const fullname = accFullname.value.trim() || null;
  const username = accUsername.value.trim() || null;
  const phone = accPhone.value.trim() || null;
  const file = accAvatarInput.files[0] || null;

  let avatarUrl = null;
  if (file) {
    // show small progress in debug (you can wire a visible progress UI)
    debug('Uploading avatar (full page)');
    try {
      const path = `public/${user.id}.png`;
      await uploadFileWithProgress(file, 'avatars', path, pct => {
        debug('Upload: ' + pct + '%');
      });
      const { data: pub } = await supabaseClient.storage.from('avatars').getPublicUrl(path);
      avatarUrl = pub?.publicUrl || `${SUPABASE_URL}/storage/v1/object/public/avatars/${encodeURIComponent(path)}`;
    } catch (err) {
      alert('Upload failed: ' + (err?.message || err));
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save';
      return;
    }
  }

  // update profile row (with clear error handling for RLS)
  try {
    const updateRes = await supabaseClient.from('profiles').update({
      full_name: fullname,
      username,
      phone,
      avatar_url: avatarUrl || undefined
    }).eq('id', user.id);

    if (updateRes.error) {
      let msg = updateRes.error.message || JSON.stringify(updateRes.error);
      if (msg.toLowerCase().includes('row-level') || msg.toLowerCase().includes('violates row-level')) {
        alert('Profile update failed due to row-level security policy: update blocked. Fix: allow authenticated users to update their profile row (policy: auth.uid() = id). See Supabase policies.');
      } else {
        alert('Profile update failed: ' + msg);
      }
      debug('Profile update error: ' + msg);
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save';
      return;
    }
  } catch (e) {
    alert('Profile update failed: ' + (e?.message || e));
    debug('Profile update thrown: ' + (e?.message || e));
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save';
    return;
  }

  // success
  saveBtn.disabled = false;
  saveBtn.textContent = 'Save';
  hideAccountPage();
  await postInitLoadUser();
  debug('Profile saved');
});

/* Sign out button on account page: sign out and redirect to index.html (refresh home) */
signoutPageBtn.addEventListener('click', async () => {
  if (supabaseClient) {
    await supabaseClient.auth.signOut();
  }
  window.location.href = 'index.html';
});

/* small helper upload function: keeps slashes, sets content-type, supports progress */
function encodePathAllowSlashes(path){
  return path.split('/').map(seg => encodeURIComponent(seg)).join('/');
}
function uploadFileWithProgress(file, bucket, path, onProgress){
  const encodedPath = encodePathAllowSlashes(path);
  const url = `${SUPABASE_URL}/storage/v1/object/${bucket}/${encodedPath}`;
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('PUT', url);
    try {
      xhr.setRequestHeader('Authorization', `Bearer ${SUPABASE_ANON_KEY}`);
      if (file && file.type) xhr.setRequestHeader('Content-Type', file.type);
      xhr.setRequestHeader('x-upsert', 'true');
    } catch(e){}
    xhr.upload.onprogress = ev => {
      if (ev.lengthComputable && typeof onProgress === 'function') {
        const pct = Math.round((ev.loaded / ev.total) * 100);
        onProgress(pct);
      }
    };
    xhr.onload = () => {
      const body = xhr.responseText || '';
      if (xhr.status >= 200 && xhr.status < 300) resolve({ status: xhr.status, body });
      else reject(new Error(`Upload failed (${xhr.status}): ${body || xhr.statusText}`));
    };
    xhr.onerror = () => reject(new Error('Network error during upload'));
    xhr.send(file);
  });
}

/* MINI edit modal open from header (legacy) */
function showAuthUI(){
  // simple prompt-based fallback if supabase missing (keeps UI-first)
  if (!supabaseClient) {
    alert('Sign in: supabase not yet initialized. Please wait a moment and try again.');
    return;
  }
  // Use Supabase magic link or sign in popup — here we show a simple prompt for quick testing.
  const email = prompt('Enter email to sign in / sign up (quick test):');
  if (!email) return;
  alert('Quick test: create/login via Supabase UI in your project. Use the Sign Up / Login buttons in debug builds.');
}

/* Auth binding once client exists */
function bindAuthHandlers(){
  if (!supabaseClient) return;
  // Sign up & Sign in flows - simple: we'll rely on the small UI fallback (or you can hook your existing popup handlers)
  // For the purposes of this overlay, we assume you use the existing sign in flow you already had.
  // postInitLoadUser will populate header when signed in
}

/* On load, sync user to header */
async function postInitLoadUser(){
  if (!supabaseClient) return;
  try {
    const { data } = await supabaseClient.auth.getUser();
    const user = data?.user;
    if (user) {
      debug('Signed in as ' + (user.email || user.id));
      // load profile row
      const res = await supabaseClient.from('profiles').select('avatar_url').eq('id', user.id).single();
      if (!res.error && res.data?.avatar_url) {
        headerAvatar.src = res.data.avatar_url;
        headerAvatar.style.display = 'block';
        profileCircle.style.display = 'flex';
      } else {
        profileCircle.style.display = 'flex';
        headerAvatar.style.display = 'none';
      }
      signinBtn.style.display = 'none';
    } else {
      debug('No signed-in user');
      signinBtn.style.display = 'inline-block';
      profileCircle.style.display = 'none';
      headerAvatar.style.display = 'none';
    }
  } catch (e) {
    debug('postInitLoadUser error: ' + (e?.message || e));
  }
}

/* Helper: open mini editor via small button in header (if you want that later) */
openEditMiniBtn.addEventListener('keydown', e => { if (e.key === 'Enter') openEditMiniBtn.click(); });

/* Init try after a short delay (in case external script still loading) */
setTimeout(initSupabase, 800);
</script>
</body>
</html>
