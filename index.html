<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shipping Experts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family:Arial,sans-serif; }
    header { background:#FF6700; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; color:#fff; }
    .profile-circle { width:40px; height:40px; border-radius:50%; background:#000; cursor:pointer; }
    .hidden { display:none; }
    #auth-modal, #edit-profile-modal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);
      justify-content:center; align-items:center;
    }
    .modal-content {
      background:#fff; padding:20px; border-radius:8px; width:300px; position:relative;
    }
    .close-btn { position:absolute; top:10px; right:10px; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <h1>Shipping Experts</h1>
    <div id="header-actions">
      <button id="signin-btn">Sign In</button>
      <!-- Profile Circle -->
      <div id="profile-circle" class="w-10 h-10 rounded-full bg-black overflow-hidden cursor-pointer hidden">
        <img id="profile-avatar" src="" alt="Profile" class="w-full h-full object-cover hidden">
      </div>
    </div>
  </header>

  <!-- Auth Modal -->
  <div id="auth-modal">
    <div class="modal-content">
      <span class="close-btn" id="auth-close">Ã—</span>
      <h2>Sign In / Sign Up</h2>
      <input id="auth-email" type="email" placeholder="Email"><br>
      <input id="auth-password" type="password" placeholder="Password"><br>
      <input id="auth-username" type="text" placeholder="Username"><br>
      <input id="auth-phone" type="text" placeholder="Phone"><br>
      <button id="signup-submit">Sign Up</button>
      <button id="signin-submit">Sign In</button>
      <p id="auth-status"></p>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div id="edit-profile-modal">
    <div class="modal-content">
      <span class="close-btn" id="edit-profile-close">Ã—</span>
      <h2>Edit Profile</h2>
      <input id="edit-fullname" type="text" placeholder="Full Name"><br>
      <input id="edit-username" type="text" placeholder="Username"><br>
      <input id="edit-phone" type="text" placeholder="Phone"><br>
      <input id="edit-email" type="email" placeholder="Email"><br>
      <input id="edit-avatar" type="file"><br>
      <button id="edit-profile-save">Save</button>
      <button id="edit-profile-cancel">Cancel</button>
      <button id="signout-btn">Sign Out</button>
      <p id="profile-status"></p>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://gxcbliwbxrnhltdosfuj.supabase.co"
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4Y2JsaXdieHJuaGx0ZG9zZnVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5ODE4MDcsImV4cCI6MjA3MzU1NzgwN30.XsQR9vmnIknlcgUT4znIHGYjY_9s2hS8ZNIke9Dn7-E"
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const signinBtn = document.getElementById('signin-btn')
    const profileContainer = document.getElementById('profile-container')
    const profileCircle = document.getElementById('profile-circle')
    const authModal = document.getElementById('auth-modal')
    const editProfileModal = document.getElementById('edit-profile-modal')

    // Open/close modals
    signinBtn.addEventListener('click', () => authModal.style.display = 'flex')
    document.getElementById('auth-close').addEventListener('click', () => authModal.style.display = 'none')
    profileCircle.addEventListener('click', () => editProfileModal.style.display = 'flex')
    document.getElementById('edit-profile-close').addEventListener('click', () => editProfileModal.style.display = 'none')
    document.getElementById('edit-profile-cancel').addEventListener('click', () => editProfileModal.style.display = 'none')

    // Sign up
    document.getElementById('signup-submit').addEventListener('click', async () => {
      const email = document.getElementById('auth-email').value
      const password = document.getElementById('auth-password').value
      const username = document.getElementById('auth-username').value
      const phone = document.getElementById('auth-phone').value

      if(!email || !password || !username || !phone){
        document.getElementById('auth-status').textContent = 'All fields are required'
        return
      }

      const { data, error } = await supabase.auth.signUp({
        email, password
      }, {
        data: { username, phone },
        options: { emailRedirectTo: window.location.href }
      })

      if(error){
        document.getElementById('auth-status').textContent = error.message
      } else {
        const { error: profileError } = await supabase.from('profiles').upsert({
          id: data.user.id,
          username, phone
        })
        document.getElementById('auth-status').textContent = profileError ? profileError.message : 'Signed up successfully! Please confirm email.'
      }
    })

    // Sign in
    document.getElementById('signin-submit').addEventListener('click', async () => {
      const email = document.getElementById('auth-email').value
      const password = document.getElementById('auth-password').value
      const { data, error } = await supabase.auth.signInWithPassword({ email, password })
      if(error){
        document.getElementById('auth-status').textContent = error.message
      } else {
        authModal.style.display = 'none'
        updateHeaderProfile(data.user)
      }
    })

    // Sign out
    document.getElementById('signout-btn').addEventListener('click', async () => {
      const { error } = await supabase.auth.signOut()
      if(error) console.error('Sign out error:', error.message)
      else {
        editProfileModal.style.display = 'none'
        updateHeaderProfile(null)
      }
    })

    // Save profile changes
    document.getElementById('edit-profile-save').addEventListener('click', async () => {
      const user = (await supabase.auth.getUser()).data.user
      const fullname = document.getElementById('edit-fullname').value
      const username = document.getElementById('edit-username').value
      const phone = document.getElementById('edit-phone').value
      const newEmail = document.getElementById('edit-email').value
      const avatarFile = document.getElementById('edit-avatar').files[0]

      // Update profiles table
      const { error: profileError } = await supabase.from('profiles').upsert({
        id: user.id, full_name: fullname, username, phone
      })
      if(profileError) {
        document.getElementById('profile-status').textContent = profileError.message
        return
      }

      // Update email
      if(newEmail){
        const { error: emailError } = await supabase.auth.updateUser({ email: newEmail })
        if(emailError){
          document.getElementById('profile-status').textContent = emailError.message
          return
        }
      }

      // Upload avatar
      if(avatarFile){
        const { error: avatarError } = await supabase.storage.from('avatars').upload(`public/${user.id}.png`, avatarFile, { upsert: true })
        if(avatarError){
          document.getElementById('profile-status').textContent = "Avatar upload error: " + avatarError.message
          return
        }
      }

      document.getElementById('profile-status').textContent = 'Profile updated successfully!'
    })

    function updateHeaderProfile(user){
  if(user){
    signinBtn.classList.add('hidden')
    profileCircle.classList.remove('hidden')
  } else {
    signinBtn.classList.remove('hidden')
    profileCircle.classList.add('hidden')
  }
}

    // Sign in
document.getElementById('signin-submit').addEventListener('click', async () => {
  const email = document.getElementById('auth-email').value
  const password = document.getElementById('auth-password').value
  const { data, error } = await supabase.auth.signInWithPassword({ email, password })

  if(error){
    document.getElementById('auth-status').textContent = error.message
  } else {
    authModal.style.display = 'none'
    updateHeaderProfile(data.user)

    // ðŸ”¥ Fetch profile details and update circle
    const { data: profile, error: profileError } = await supabase
      .from("profiles")
      .select("*")
      .eq("id", data.user.id)
      .single()

    if (!profileError) {
      updateProfileCircle(profile)
    }
  }
})


   supabase.auth.getUser().then(async ({ data }) => {
  const user = data.user
  updateHeaderProfile(user)
  if(user){
    const { data: profile } = await supabase
      .from("profiles")
      .select("*")
      .eq("id", user.id)
      .single()
    if(profile) updateProfileCircle(profile)
  }
})


    // Show profile avatar in header
function updateProfileCircle(profile) {
  const circle = document.getElementById("profile-circle");
  const avatarImg = document.getElementById("profile-avatar");

  if (!circle || !avatarImg) return;

  if (profile && profile.avatar_url) {
    // User has avatar uploaded
    avatarImg.src = profile.avatar_url;
    avatarImg.classList.remove("hidden");
    circle.classList.remove("bg-black"); // remove placeholder
  } else {
    // No avatar, show black placeholder
    avatarImg.classList.add("hidden");
    circle.classList.add("bg-black");
  }

  circle.classList.remove("hidden");
}

    
  </script>
</body>
</html>
